<%- include('partials/header') %>

<style>
    #global-loader {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7); /* Fundo escuro semi-transparente */
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        
        /* Transição Suave */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.4s ease-in-out, visibility 0.4s ease-in-out;
        
        /* Efeito de Desfoque (Glassmorphism) */
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    #global-loader.visible {
        opacity: 1;
        visibility: visible;
    }

    /* Animação suave no texto */
    #global-loader-text {
        animation: pulse 1.5s infinite ease-in-out;
    }

    @keyframes pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }
</style>

<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <div class="page-pretitle">Overview</div>
        <h2 class="page-title">My Servers</h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <button class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-new-instance">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5" /><path d="M12 12l8 -4.5" /><path d="M12 12l0 9" /><path d="M12 12l-8 -4.5" /></svg>
            Create Server
        </button>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    
    <% if (typeof query !== 'undefined' && query.error) { %>
        <div class="alert alert-danger"><%= query.error %></div>
    <% } %>

    <div class="row row-cards">
        <% if (instances && instances.length > 0) { %>
            <% instances.forEach(function(inst) { %>
            <div class="col-sm-6 col-lg-4">
                <a href="/server/<%= inst.uuid %>" class="card card-link card-link-pop">
                    <% if (inst.status == 'running') { %>
                        <div class="card-status-top bg-success"></div>
                    <% } else if (inst.status == 'crashed') { %>
                        <div class="card-status-top bg-danger"></div>
                    <% } else { %>
                        <div class="card-status-top bg-secondary"></div>
                    <% } %>

                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <span class="avatar me-3 rounded bg-blue-lt">
                                <%= inst.name.substring(0,2).toUpperCase() %>
                            </span>
                            <div>
                                <h3 class="card-title lh-1 mb-1"><%= inst.name %></h3>
                                <div class="text-muted"><%= inst.domain %></div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <div class="text-muted small">Port</div>
                                <div class="font-weight-medium"><%= routerPort %></div>
                            </div>
                            <div class="col-6 text-end">
                                <div class="text-muted small">Status</div>
                                <% if (inst.status == 'running') { %>
                                    <span class="badge bg-success">Running</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">Stopped</span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
            <% }); %>
        <% } else { %>
            <div class="col-12 text-center py-5">
                <div class="empty">
                    <div class="empty-header">No Servers</div>
                    <p class="empty-title">Create your first Minecraft Server</p>
                    <div class="empty-action">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-new-instance">
                            Create Server
                        </button>
                    </div>
                </div>
            </div>
        <% } %>
    </div>

  </div>
</div>

<div class="modal modal-blur fade" id="modal-new-instance" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <form action="/instances/create" method="POST" enctype="multipart/form-data" onsubmit="showGlobalLoader('Creating Server... This may take a few seconds.')">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Create New Server</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Server Name</label>
                <input type="text" class="form-control" name="name" placeholder="survival01" required>
                <small class="form-hint">Internal folder name.</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Domain</label>
                <input type="text" class="form-control" name="domain" placeholder="play.myserver.com" required>
                <small class="form-hint">Listening on port <%= routerPort %></small>
            </div>
            <div class="mb-3">
                <label class="form-label">Server JAR File</label>
                <input type="file" class="form-control" name="serverJar" accept=".jar" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Start Command (Optional)</label>
                <input type="text" class="form-control" name="startCommand" placeholder="java -Xmx1024M -Xms1024M -jar {jar} nogui">
                <small class="form-hint">Use <code>{jar}</code> as placeholder for the filename. Default: <code>java -Xmx1024M -Xms1024M -jar {jar} nogui</code></small>
            </div>

        </div>
        <div class="modal-footer">
            <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</a>
            <button type="submit" class="btn btn-primary ms-auto">Create</button>
        </div>
        </div>
    </form>
  </div>
</div>

<div id="global-loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    <div id="global-loader-text" class="mt-3 text-white h2">Processing...</div>
</div>

<script>
    function showGlobalLoader(msg) {
        // Esconde modais abertos
        const modals = document.querySelectorAll('.modal');
        modals.forEach(m => {
            try {
                const instance = bootstrap.Modal.getInstance(m);
                if(instance) instance.hide();
            } catch(e){}
        });

        document.getElementById('global-loader-text').innerText = msg || "Processing...";
        // Adiciona a classe que ativa a opacidade/visibilidade
        document.getElementById('global-loader').classList.add('visible');
    }
</script>

<%- include('partials/footer') %>