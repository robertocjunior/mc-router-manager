<%- include('partials/header') %>

<div class="page-header d-print-none">
  <div class="container-xl">
    <div class="row g-2 align-items-center">
      <div class="col">
        <h2 class="page-title">Dashboard</h2>
      </div>
      <div class="col-auto ms-auto d-print-none">
        <div class="btn-list">
            <button class="btn btn-success d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-new-instance">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 3l8 4.5l0 9l-8 4.5l-8 -4.5l0 -9l8 -4.5" /><path d="M12 12l8 -4.5" /><path d="M12 12l0 9" /><path d="M12 12l-8 -4.5" /></svg>
                New Server (Upload JAR)
            </button>
            <button class="btn btn-primary d-none d-sm-inline-block" data-bs-toggle="modal" data-bs-target="#modal-new-route">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></svg>
                New Proxy Route
            </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page-body">
  <div class="container-xl">
    
    <div class="row row-cards mb-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">My Servers (Local Instances)</h3>
                </div>
                <div class="table-responsive">
                    <table class="table table-vcenter card-table">
                        <thead>
                            <tr>
                                <th>Name / ID</th>
                                <th>Address (Domain)</th>
                                <th>Internal Port</th>
                                <th>Status</th>
                                <th>JAR File</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (instances && instances.length > 0) { %>
                                <% instances.forEach(function(inst) { %>
                                <tr>
                                    <td><span class="font-weight-bold"><%= inst.name %></span></td>
                                    <td>
                                        <a href="#" class="text-reset"><%= inst.domain %></a>
                                    </td>
                                    <td><span class="badge bg-blue-lt"><%= inst.port %></span></td>
                                    <td>
                                        <% if (inst.status == 'running') { %>
                                            <span class="badge bg-success">Running (PID <%= inst.pid %>)</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">Stopped</span>
                                        <% } %>
                                    </td>
                                    <td class="text-muted"><%= inst.jarFile %></td>
                                </tr>
                                <% }); %>
                            <% } else { %>
                                <tr><td colspan="5" class="text-center py-4 text-muted">No servers created yet.</td></tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row row-cards">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Proxy Routes (All)</h3>
          </div>
          <div class="table-responsive">
            <table class="table table-vcenter card-table">
              <thead>
                <tr>
                  <th>Ingress (Source)</th>
                  <th>Destination (Server)</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th class="w-1"></th>
                </tr>
              </thead>
              <tbody>
                <% routes.forEach(function(route) { %>
                <tr>
                  <td>
                    <div class="d-flex flex-column">
                      <span class="font-weight-bold mb-1"><%= route.sourceDomain || 'Any / Wildcard' %></span>
                      <div class="text-muted small">Port: 25565</div>
                    </div>
                  </td>
                  <td>
                    <%= route.destHost %>:<%= route.destPort %>
                  </td>
                  <td class="text-muted"><%= route.description || '-' %></td>
                  <td>
                    <span class="badge bg-success me-1"></span> Online
                  </td>
                  <td>
                    <form action="/routes/delete/<%= route.id %>" method="POST" onsubmit="return confirm('Are you sure?');">
                        <button type="submit" class="btn btn-ghost-danger btn-icon" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="7" x2="20" y2="7" /><line x1="10" y1="11" x2="10" y2="17" /><line x1="14" y1="11" x2="14" y2="17" /><path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12" /><path d="M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3" /></svg>
                        </button>
                    </form>
                  </td>
                </tr>
                <% }); %>
                <% if (routes.length === 0) { %>
                    <tr><td colspan="5" class="text-center py-4 text-muted">No routes configured.</td></tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-new-instance" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <form action="/instances/create" method="POST" enctype="multipart/form-data">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">Create New Server</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                <label class="form-label">Server Name (ID)</label>
                <input type="text" class="form-control" name="name" placeholder="survival01" required>
                <small class="form-hint">Internal name for the folder (no spaces recommended).</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Domain (Ingress)</label>
                <input type="text" class="form-control" name="domain" placeholder="play.myserver.com" required>
                <small class="form-hint">The router will automatically point this domain to your new server.</small>
            </div>

            <div class="mb-3">
                <label class="form-label">Server JAR File</label>
                <input type="file" class="form-control" name="serverJar" accept=".jar" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Custom Start Command (Optional)</label>
                <input type="text" class="form-control" name="startCommand" placeholder="java -Xmx2G -jar {jar} nogui">
                <small class="form-hint">Leave empty to use default. Use <code>{jar}</code> as placeholder for filename.</small>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</a>
            <button type="submit" class="btn btn-success ms-auto">Upload & Start Server</button>
        </div>
        </div>
    </form>
  </div>
</div>

<div class="modal modal-blur fade" id="modal-new-route" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <form action="/routes/add" method="POST">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title">New External Proxy Route</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row mb-3">
                <div class="col-12 mb-2"><label class="form-label text-primary">Ingress Settings</label></div>
                <div class="col-12">
                    <label class="form-label">Ingress Address (Domain)</label>
                    <input type="text" class="form-control" name="sourceDomain" placeholder="play.myserver.com">
                </div>
            </div>
            <hr class="my-4">
            <div class="row mb-3">
                <div class="col-12 mb-2"><label class="form-label text-green">Destination Settings</label></div>
                <div class="col-lg-8">
                    <label class="form-label">Server IP or Address</label>
                    <input type="text" class="form-control" name="destHost" placeholder="192.168.1.50" required>
                </div>
                <div class="col-lg-4">
                    <label class="form-label">Server Port</label>
                    <input type="number" class="form-control" name="destPort" placeholder="25565" required>
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Description</label>
                <input type="text" class="form-control" name="description">
            </div>
        </div>
        <div class="modal-footer">
            <a href="#" class="btn btn-link link-secondary" data-bs-dismiss="modal">Cancel</a>
            <button type="submit" class="btn btn-primary ms-auto">Save Route</button>
        </div>
        </div>
    </form>
  </div>
</div>

<%- include('partials/footer') %>